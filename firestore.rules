
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla de denegación por defecto para mayor seguridad
    match /{document=**} {
      allow read, write: if false;
    }

    // COLECCIÓN DE USUARIOS
    // Cualquier usuario autenticado puede leer perfiles (para verlos).
    // Un usuario solo puede crear, actualizar o eliminar su propio documento.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;
    }

    // COLECCIÓN DE TRANSACCIONES
    // Solo los participantes en una transacción pueden acceder a ella.
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }

    // COLECCIÓN DE PUBLICACIONES
    // Cualquiera puede leer publicaciones, pero solo el autor puede modificarlas.
    match /publications/{publicationId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // COLECCIÓN DE NOTIFICACIONES
    // Un usuario solo puede acceder a sus propias notificaciones.
    match /notifications/{notificationId} {
      allow read, write, create, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // COLECCIÓN DE CONVERSACIONES
    // Solo los participantes en una conversación pueden acceder a ella.
    match /conversations/{conversationId} {
        allow read, write: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }

    // SESIONES QR
    // Solo los participantes de una sesión QR pueden acceder a ella.
    match /qr_sessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }
  }
}
