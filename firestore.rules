
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Función de ayuda para verificar si un usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para verificar si el usuario que hace la solicitud es el dueño del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Función para verificar si el usuario es un participante de un documento (transacción, conversación)
    function isParticipant(resource) {
        return request.auth.uid in resource.data.participantIds;
    }

    // Colección de Usuarios
    match /users/{userId} {
      // Cualquiera puede leer perfiles públicos.
      allow read: if isAuthenticated();
      
      // Un usuario solo puede crear su propio perfil.
      allow create: if isOwner(userId);
      
      // Un usuario solo puede actualizar su propio perfil, pero no puede asignarse roles.
      allow update: if isOwner(userId) && !("role" in request.resource.data);
    }
    
    // Colección de Publicaciones (el feed público)
    match /publications/{publicationId} {
        // Cualquiera puede leer las publicaciones.
        allow read: if isAuthenticated();
        
        // Solo el proveedor dueño puede crear, actualizar o borrar su publicación.
        allow write: if isOwner(request.resource.data.providerId);
    }
    
     // Subcolección de galería de un usuario
    match /users/{userId}/gallery/{imageId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Colección de Productos
    match /products/{productId} {
        allow read: if isAuthenticated();
        // Solo el proveedor puede crear o modificar sus productos.
        allow write: if isOwner(request.resource.data.providerId);
    }
    
    // Colección de Conversaciones
    match /conversations/{conversationId} {
        // Solo los participantes de la conversación pueden leerla o escribir en ella.
        allow read, write: if isParticipant(resource);
    }
    
    // Colección de Transacciones
    match /transactions/{transactionId} {
        // Solo los participantes de la transacción pueden acceder a ella.
        allow read, write: if isParticipant(resource);
    }
    
    // Colección de Notificaciones
    match /notifications/{notificationId} {
        // Solo el destinatario de la notificación puede leerla o escribir en ella.
        allow read, write: if isOwner(resource.data.userId);
    }
    
    // Colección de Campañas
    match /campaigns/{campaignId} {
        // Cualquiera puede leer los datos de una campaña.
        allow read: if isAuthenticated();
        // Solo el proveedor puede crear o actualizar su campaña.
        allow write: if isOwner(request.resource.data.providerId);
    }
  }
}
