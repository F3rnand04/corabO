rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección de Usuarios
    match /users/{userId} {
      // Un usuario solo puede leer y escribir en su propio documento.
      // Esto previene que un usuario pueda modificar los datos de otro.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para la colección de Publicaciones (unificada)
    match /publications/{publicationId} {
      // **Lectura (Read):** Cualquiera puede leer las publicaciones.
      // Esto es necesario para que el feed principal y los perfiles públicos funcionen.
      allow read: if request.auth != null;

      // **Creación (Create):** Un usuario autenticado puede crear una publicación
      // si el 'providerId' del nuevo documento coincide con su propio ID de usuario.
      // Esto asegura que los usuarios solo puedan publicar en su propio nombre.
      allow create: if request.auth != null && request.resource.data.providerId == request.auth.uid;

      // **Actualización (Update) y Eliminación (Delete):**
      // Solo el propietario original de la publicación puede actualizarla o borrarla.
      // Se compara el 'providerId' del documento existente (resource.data) con el ID del usuario.
      allow update, delete: if request.auth != null && resource.data.providerId == request.auth.uid;
    }

    // Reglas para colecciones de soporte (Transacciones, Conversaciones, etc.)
    // Cualquiera puede leer o escribir si está autenticado.
    // En una app de producción, estas reglas serían más granulares.
    // Por ejemplo: solo los participantes de una conversación pueden leer/escribir en ella.
    match /{collection}/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
